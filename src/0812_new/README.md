# 🤖 ROSA (Robot Operation & Service Automation) 시스템 최종 가이드

**진화된 다중 로봇 자동 배달 관제 시스템**

ROSA는 여러 대의 자율주행 로봇을 통합 관리하여, 복잡한 환경(병원, 요양원, 호텔 등)에서 안정적인 자동 배달 서비스를 제공하는 ROS2 기반의 지능형 관제 시스템입니다. 이 문서는 새로운 팀원이 시스템의 모든 기능을 이해하고, 시뮬레이션을 실행하며, 다른 시스템과 연동할 수 있도록 돕는 최종 가이드입니다.

---

## 📋 목차
- [**1. 시스템의 핵심 철학 및 특징**](#1-시스템의-핵심-철학-및-특징)
- [**2. 주요 기능 상세 설명 (v2.0)**](#2-주요-기능-상세-설명-v20)
- [**3. 시뮬레이션 실행 및 검증 방법 (가장 중요!)**](#3-시뮬레이션-실행-및-검증-방법-가장-중요)
- [**4. 시스템 아키텍처**](#4-시스템-아키텍처)
- [**5. 로봇 상태(State) 완벽 가이드**](#5-로봇-상태state-완벽-가이드)
- [**6. 명령어 목록**](#6-명령어-목록)
- [**7. 주요 파일 설명**](#7-주요-파일-설명)
- [**8. 문제 해결 가이드**](#8-문제-해결-가이드)

---

## **1. 시스템의 핵심 철학 및 특징**

ROSA는 단순한 로봇 제어를 넘어, **안정성**, **확장성**, **직관성**이라는 세 가지 핵심 철학을 바탕으로 설계되었습니다.

-   **안정성 (Robustness)**: 주행 중 타임아웃, 예약 실패, 통신 두절 등 예외 상황을 스스로 감지하고 **자동으로 복구**하는 로직이 포함되어 24시간 운영 환경에서도 안정성을 보장합니다.
-   **확장성 (Scalability)**: 새로운 로봇, 장소, 물품을 `config.py` 파일 수정만으로 쉽게 추가할 수 있는 유연한 구조를 가집니다.
-   **직관성 (Intuitive)**: 자연어 명령으로 누구나 쉽게 로봇에게 임무를 부여할 수 있으며, 모든 시스템 상태와 로그를 시각적으로 분리된 GUI와 로거를 통해 한눈에 파악할 수 있습니다.

---

## **2. 주요 기능 상세 설명 (v2.0)**

기존 기능에 더해, 다음과 같은 고도화된 기능들이 구현되었습니다.

-   **✨ 지능형 상태 관리**:
    -   **11개의 세분화된 로봇 상태**를 통해 로봇의 모든 행동을 정밀하게 추적하고 제어합니다.
    -   **주행 실패 자동 감지**: 로봇이 이동/복귀 등 주행 상태에서 1분 이상 멈춰있으면 **[장애]** 상태로 전환 후, 스스로 업무를 취소하고 충전소로 복귀합니다.

-   **✨ 동적 시각화 관리자 GUI (`admin_gui.py`)**:
    -   **실시간 맵 모니터링**: 맵 이미지 위에 로봇의 현재 위치와 장소(방, 픽업대 등)의 상태를 **실시간으로 시각화**합니다.
    -   **상태 기반 색상 변경**: 로봇과 장소의 상태가 바뀔 때마다, 설정된 색상으로 마커 색이 동적으로 변경되어 현황을 직관적으로 파악할 수 있습니다.
        -   **로봇**: `이동중(초록)`, `작업중(노랑)`, `복귀중(파랑)`, `장애(빨강)` 등
        -   **장소**: `비어있음(파랑)`, `예약됨(초록)`, `사용중(노랑)`

-   **✨ 향상된 사용자 GUI 로직 (`gui_example.py`)**:
    -   **수령 거부 기능**: 사용자가 배달 확인 창에서 '아니오'를 선택하면, 로봇은 작업을 완료하지 않고 해당 자리에서 재확인을 대기합니다.
    -   **명확한 피드백**: '아니오' 선택 시, 확인 창의 문구가 "로봇 대기 중. 수령 후 '예'를 눌러주세요."로 변경되어 사용자에게 다음 행동을 안내합니다.

-   **✨ 분리된 로깅 시스템**:
    -   **명령어 터미널 (`main.py`)**: 사용자가 명령을 내리고 직접적인 응답을 받는 창은 더 이상 시스템 내부 로그로 오염되지 않고 깔끔하게 유지됩니다.
    -   **시스템 로그 터미널 (`status_logger.py`)**: 로봇의 모든 상태 변화, 정보, 경고 등 상세한 시스템 로그는 이곳에서 집중적으로 모니터링할 수 있습니다.

-   **✨ 원격 로봇 호출 (외부 GUI 연동)**:
    -   외부 사용자 GUI에서 '호출' 버튼을 누르면, 지정된 로봇이 사용자의 위치(예: 왼쪽방)로 이동하는 기능을 지원합니다.
    -   시스템 내부적으로는 **단순 이동 명령**으로 처리되며, 자세한 연동 방식은 `GUI_연동_가이드.md` 문서를 참고하세요.

---

## **3. 시뮬레이션 실행 및 검증 방법 (가장 중요!)**

다른 팀원의 GUI/Server/DB와 연동하기 전, 이 시뮬레이션 모드를 통해 **관제 시스템의 모든 기능이 완벽하게 동작하는지 독립적으로 검증**할 수 있습니다.

### **실행 방법**

총 **4개의 터미널**을 열고, 아래의 명령어를 각각의 터미널에서 순서대로 실행합니다.

> **💡 팁**: 각 터미널 창의 제목을 `1.메인`, `2.로그`, `3.관리자GUI`, `4.사용자GUI`로 설정해두면 편리합니다.

#### **터미널 1: 메인 시스템 실행**
-   **역할**: 전체 시스템(TaskManager)을 총괄하고, 자연어 명령을 입력받습니다.
-   **명령어**:
    ```bash
    PYTHONIOENCODING=utf-8 python3 src/0812_new/main.py
    ```
-   **실행 후**: `실행 모드를 선택하세요`라는 메시지가 나타나면, 키보드로 `2`를 입력하고 엔터를 칩니다. `[시뮬레이션 모드]로 시작합니다.`라는 메시지를 확인합니다.

#### **터미널 2: 시스템 로그 모니터 실행**
-   **역할**: 로봇의 모든 상태 변화, 정보, 경고 등 시스템의 상세한 내부 동작을 실시간으로 보여줍니다.
-   **명령어**:
    ```bash
    python3 src/0812_new/status_logger.py
    ```

#### **터미널 3: 관리자 GUI 실행**
-   **역할**: 맵, 로봇 위치, 장소 상태, 주요 경고, DB 로그를 종합적으로 시각화하여 보여주는 모니터링 대시보드입니다.
-   **명령어**:
    ```bash
    python3 src/0812_new/admin_gui.py
    ```

#### **터미널 4: 사용자 수령확인 GUI 실행**
-   **역할**: 로봇이 배달을 완료했을 때, 최종적으로 물품을 수령했는지 확인하는 '사용자용' 확인 창입니다.
-   **명령어**:
    ```bash
    python3 src/0812_new/gui_example.py
    ```

### **검증 시나리오 및 체크리스트**

모든 창이 준비되었다면, 아래 시나리오에 따라 시스템이 정확히 동작하는지 확인합니다.

1.  **배달 명령 내리기**:
    -   **[수행]** `터미널 1 (메인)`에서 `3번 왼쪽방 물 배달` 이라고 입력하고 엔터를 칩니다.
    -   **[확인]**
        -   `터미널 2 (로그)`: `NEW_TASK` 로그와 함께 로봇의 상태가 `IDLE` -> `AWAITING_PICKUP_RESERVATION` -> `MOVING_TO_PICKUP` 등으로 순차적으로 변경되는 로그가 출력되는지 확인합니다.
        -   `터미널 3 (관리자 GUI)`:
            -   `DP_03` 로봇 마커의 색이 **초록색(이동중)**으로 바뀌고, '픽업대'를 향해 움직이는지 확인합니다.
            -   '픽업대' 장소 마커의 색이 **초록색(예약됨)**으로 바뀌는지 확인합니다.

2.  **픽업 과정 확인**:
    -   **[수행]** 로봇이 픽업대에 도착하는 것을 기다립니다. (시뮬레이션 시간 약 2초)
    -   **[확인]**
        -   `터미널 2 (로그)`: 로봇 상태가 `PICKING_UP` -> `AWAITING_DEST_RESERVATION`으로 변경되는지 확인합니다.
        -   `터미널 3 (관리자 GUI)`:
            -   `DP_03` 로봇 마커의 색이 **노란색(작업중)**으로 잠시 바뀐 후, 다시 **초록색(이동중)**으로 바뀌며 '왼쪽방'으로 향하는지 확인합니다.
            -   '픽업대' 장소 마커의 색이 **노란색(사용중)**으로 바뀌었다가, 로봇이 떠나면 다시 **파란색(비어있음)**으로 바뀌는지 확인합니다.
            -   '왼쪽방' 장소 마커의 색이 **초록색(예약됨)**으로 바뀌는지 확인합니다.

3.  **배달 및 수령확인**:
    -   **[수행]** 로봇이 '왼쪽방'에 도착하는 것을 기다립니다. (시뮬레이션 시간 약 2초)
    -   **[확인]**
        -   `터미널 4 (사용자 GUI)`: **"물품을 받았습니까?"** 라는 내용의 수령확인 창이 나타나는지 확인합니다.
        -   `터미널 3 (관리자 GUI)`: `DP_03` 로봇 마커의 색이 **초록색(확인중)**으로 바뀌고 '왼쪽방'에 멈춰있는지 확인합니다. '왼쪽방' 장소 마커는 **노란색(사용중)**으로 바뀝니다.
    -   **[수행]** `터미널 4 (사용자 GUI)`에서 **'예(Y)'** 버튼을 클릭합니다.
    -   **[확인]**
        -   `터미널 2 (로그)`: 로봇 상태가 `RETURNING`(복귀중)으로 바뀌는 것을 확인합니다.
        -   `터미널 3 (관리자 GUI)`:
            -   `DP_03` 로봇 마커의 색이 **파란색(복귀중)**으로 바뀌고 '3번 충전소'로 이동하는지 확인합니다.
            -   '왼쪽방' 장소 마커의 색이 **파란색(비어있음)**으로 바뀌는지 확인합니다.
            -   `최근 작업 완료 기록`에 방금 완료한 배달 작업이 로그로 남는지 확인합니다.

---

## **4. 시스템 아키텍처**

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   관제 PC (중앙 서버)  │    │   로봇 (DP_03 등) │    │  외부 시스템 연동   │
│                 │    │                 │    │ (팀원 개발 영역)    │
│ ┌─TaskManager───┼───►│ ┌─PathExecutor  │◄───┼─►┌─사용자 GUI     │
│ ├─CommandParser │    │ ├─Nav2 Stack    │    │ ├─웹/앱 서버     │
│ └─(통합)LocationMgr │    │ └─기타 센서 드라이버│    │ └─데이터베이스     │
└────────┬────────┘    └─────────────────┘    └────────┬────────┘
         │                                             │
         └───────────── ROS2 DDS 통신 ───────────────┘
         ▲
         │
┌────────┴────────┐
│ 관리자 & 개발자      │
│ ┌─admin_gui.py  │
│ ├─status_logger │
│ └─main.py (CLI) │
└─────────────────┘
```

-   **`TaskManager`**: 모든 로봇의 상태를 관리하고, 업무를 할당하며, 장소 점유 상태를 제어하는 시스템의 두뇌입니다.
-   **`PathExecutor`**: 각 로봇 위에서 실행되며, `TaskManager`로부터 받은 경로를 실제로 수행하는 팔다리 역할을 합니다.
-   **외부 시스템**: `TaskManager`가 발행하는 ROS 토픽을 구독/발행하여, 별도의 GUI, 서버, DB와 완벽하게 연동될 수 있습니다.

---

## **5. 로봇 상태(State) 완벽 가이드**

로봇의 모든 행동을 정의하는 상태 목록입니다. `admin_gui`와 `status_logger`에서 이 상태 이름을 확인할 수 있습니다.

| 상태 이름                       | 상태 색상 | 설명                                                               |
| ------------------------------- | --------- | ------------------------------------------------------------------ |
| `CHARGING`                      | **파랑**  | 충전소에서 배터리를 충전 중인 상태.                                |
| `IDLE`                          | **초록**  | 충전 완료 후, 충전소에서 새로운 명령을 기다리는 상태.              |
| `WAITING`                       | **초록**  | 배달 거부, 길 막힘 등 특정 위치에서 관리자의 개입을 기다리는 상태. |
| `AWAITING_PICKUP_RESERVATION`   | **초록**  | 픽업 장소로 가기 전, 해당 장소가 비어있는지 예약 시도하는 상태.    |
| `MOVING_TO_PICKUP_WAIT`         | **초록**  | 픽업대가 바빠서, 근처의 '픽업대기장소'로 이동하는 상태.            |
| `WAITING_AT_PICKUP_QUEUE`       | **초록**  | '픽업대기장소'에서 픽업대가 비워지기를 기다리는 상태.              |
| `MOVING_TO_PICKUP`              | **초록**  | 픽업 장소로 이동 중인 상태.                                        |
| `PICKING_UP`                    | **노랑**  | 픽업 장소에서 물건을 싣는 모션을 수행하는 상태 (시뮬레이션 2초).   |
| `AWAITING_DEST_RESERVATION`     | **초록**  | 최종 목적지로 가기 전, 해당 장소를 예약 시도하는 상태.             |
| `MOVING_TO_DEST`                | **초록**  | 최종 목적지로 이동 중인 상태.                                      |
| `AWAITING_CONFIRMATION`         | **초록**  | 목적지 도착 후, 사용자의 GUI 수령 확인을 기다리는 상태.            |
| `RETURNING`                     | **파랑**  | 업무 완료 후, 충전소로 복귀 중인 상태.                             |
| `EMERGENCY_STOP`                | **빨강**  | '멈춰' 명령으로 모든 동작을 즉시 멈춘 상태.                        |
| `FAILURE`                       | **빨강**  | 주행 중 1분 이상 멈춰서 장애로 판단, 강제 복귀를 시작하는 상태.    |
| `OFF_DUTY`                      | **파랑**  | '복귀해' 명령을 받아 강제로 복귀 중인 상태.                        |

---

## **6. 명령어 목록**

`터미널 1 (메인)`에서 다음 형식으로 명령을 내릴 수 있습니다.

-   **배달**: `[로봇] [장소] [물품] 배달` (예: `3번 왼쪽방 물 배달`)
-   **이동**: `[로봇] [장소] 가` (예: `8번 픽업대 가`)
-   **상태 확인**: `[로봇] 뭐해` 또는 `[로봇] 어디야`
-   **전체 상태 확인**: `다들 뭐해` 또는 `모두 어디야`
-   **비상 정지**: `[로봇] 멈춰` 또는 `다들 멈춰`
-   **업무 재개**: `[로봇] 계속해`
-   **강제 복귀**: `[로봇] 복귀해` 또는 `다들 퇴근해`
-   **상태 리셋**: `[로봇] 정신차려` 또는 `전체 새로고침`

---

## **7. 주요 파일 설명**

-   `main.py`: 시스템을 시작하고, 사용자 명령을 입력받는 진입점.
-   `task_manager.py`: **(가장 중요)** 모든 로직이 담긴 핵심 파일. 로봇 상태 관리, 업무 할당, 스케줄링, 예외 처리를 모두 담당.
-   `command_parser.py`: `main.py`로 들어온 자연어 명령을 해석하여 `TaskManager`가 알아들을 수 있는 함수로 변환.
-   `admin_gui.py`: **(시각화)** Tkinter 기반의 관리자용 GUI. 맵, 로봇/장소 상태, 로그를 시각화.
-   `status_logger.py`: **(로깅)** 시스템의 모든 상세 동작을 터미널에 출력. 디버깅 및 상태 추적에 필수.
-   `gui_example.py`: **(외부연동 예시)** 배달 완료 시 뜨는 사용자 확인 창의 예시. 다른 팀원이 이 파일을 참고하여 자신들의 GUI/서버에 기능을 이식할 수 있음.
-   `simulation_test.py`: 시뮬레이션 모드일 때, 실제 로봇의 동작(이동, 픽업 등)을 시간 기반으로 흉내 내는 모듈.
-   `config.py`: 로봇 이름, 장소 좌표, 물품 종류 등 시스템의 모든 주요 변수를 관리하는 중앙 설정 파일.
-   `waypoints.yaml`: 로봇의 주행 경로(고속도로)와 최종 목적지들의 좌표를 정의.
-   `delivery_interface.py`: `TaskManager`와 외부 GUI/DB의 연동을 책임지는 중간 다리.

---

## **8. 문제 해결 가이드**

-   **Q: `admin_gui`에 로봇이나 장소 마커가 안 보여요.**
    -   **A:** `config.py`의 `LOCATIONS` 좌표가 올바른지, `admin_gui.py`의 `world_to_canvas` 함수가 좌표 변환을 잘 하고 있는지 확인하세요. 맵 파일 경로가 정확한지도 확인해야 합니다.

-   **Q: 로봇이 이동하다가 멈추고 `FAILURE` 상태가 돼요.**
    -   **A:** 정상적인 기능입니다. 로봇의 상태가 1분 이상 `MOVING_*` 또는 `RETURNING`에 머물러 있으면 장애로 판단하고 스스로 복귀합니다. 시뮬레이션 시간이 너무 길거나, 실제 로봇의 `path_executor`가 응답을 못 하는 경우일 수 있습니다.

-   **Q: `status_logger`에 로그가 너무 많아서 보기 힘들어요.**
    -   **A:** 정상입니다. `status_logger`는 디버깅을 위해 모든 정보를 보여주도록 설계되었습니다. 전체적인 현황은 `admin_gui`로 파악하고, 특정 문제의 원인을 찾을 때 `status_logger`를 활용하세요.
