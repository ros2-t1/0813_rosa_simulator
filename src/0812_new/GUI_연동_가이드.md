# 🤝 ROSA - 외부 GUI/서버/DB 연동 최종 가이드

## **1. 개요**

이 문서는 ROSA 관제 시스템(`TaskManager`)과 다른 팀원이 개발한 **외부 시스템(사용자 GUI, 웹 서버, 데이터베이스 등)을 연동하는 방법**을 상세히 설명합니다.

ROSA는 모든 외부 연동을 **ROS2 토픽(Topic)** 기반으로 수행합니다. 즉, 외부 시스템은 ROS2 토픽을 통해 ROSA와 데이터를 주고받기만 하면 되므로, 특정 프로그래밍 언어나 프레임워크에 종속되지 않고 **완벽하게 분리된 개발**이 가능합니다.

`gui_example.py`는 이 연동 방식을 보여주는 **Tkinter 기반의 참고용 예시**이며, 실제 운영 시스템은 웹(React, Vue), 앱(Android, iOS), 또는 다른 데스크톱 애플리케이션으로 자유롭게 구현할 수 있습니다.

---

## **2. 연동 아키텍처**

```
                                 ┌──────────────────────────┐
                                 │        ROSA 관제 시스템        │
                                 │       (task_manager.py)      │
                                 └─────────────┬────────────┘
                                               │
                                (delivery_interface.py)
                                               │
                 ┌─────────────────────────────┴─────────────────────────────┐
                 │                         ROS2 DDS 통신                         │
                 └─────────────────────────────┬─────────────────────────────┘
                                               │
                 ┌─────────────────────────────┴─────────────────────────────┐
                 │                      외부 시스템 (팀원 개발 영역)                     │
                 │                                                           │
 ┌───────────────┴───────────────┐   ┌───────────────┴───────────────┐   ┌───────────────┴───────────────┐
 │         사용자 GUI/웹앱         │   │            백엔드 서버            │   │           데이터베이스            │
 │ (React, Vue, Android, etc.) │   │      (Node.js, Django, etc.)      │   │         (MySQL, MongoDB, etc.)        │
 └───────────────────────────────┘   └───────────────────────────────┘   └───────────────────────────────┘
```

-   **`delivery_interface.py`**: `TaskManager` 내부에서 외부 시스템과의 연동을 전담하는 모듈입니다. 모든 연동 토픽의 발행(Publish)과 구독(Subscribe)은 이 파일을 통해 이루어집니다.
-   **ROS2 DDS 통신**: 외부 시스템은 ROSA와 동일한 네트워크(DDS)에 접속하여, 아래에 정의된 토픽들로 통신합니다.

---

## **3. 연동을 위한 핵심 ROS 토픽 (API 명세)**

외부 시스템은 아래 토픽들만 알고 있으면 ROSA의 모든 배달 관련 기능과 연동할 수 있습니다.

### **[OUT] `TaskManager` → 외부 시스템**

ROSA가 외부 시스템으로 정보를 **발행(Publish)**하는 토픽들입니다. 외부 시스템은 이 토픽들을 **구독(Subscribe)**해야 합니다.

#### **1. 배달 수령 확인 요청**
-   **토픽 이름**: `/rosa/delivery_confirmation_request`
-   **타입**: `std_msgs/String`
-   **전송 시점**: 로봇이 목적지에 도착하여 물품 전달 준비가 완료되었을 때.
-   **메시지 형식**: `업무ID|사용자ID|로봇명|목적지|물품명|주문시간|배달완료시간` (각 필드는 `|`로 구분)
-   **예시**: `DP_03_1691901234|user123|DP_03|왼쪽방|물|1691901234|1691901534`
-   **활용 방안**: 이 메시지를 받으면, `사용자ID`에 해당하는 클라이언트(웹, 앱 등)에 **수령확인 UI**를 띄워줍니다.

#### **2. 작업 완료/실패 기록 (DB 저장용)**
-   **토픽 이름**: `/rosa/db_log`
-   **타입**: `std_msgs/String`
-   **전송 시점**: 하나의 배달 임무가 '수령 완료' 또는 '수령 거부'로 최종 확정되었을 때.
-   **메시지 형식**: `DB_RECORD|KEY=VALUE|KEY=VALUE|...`
-   **예시**: `DB_RECORD|ORDER_ID=DP_03...|USER_ID=user123|ROBOT=DP_03|ITEM=물|...|STATUS=수령완료`
-   **활용 방안**: 이 메시지를 파싱하여 외부 데이터베이스에 배달 이력을 영구적으로 저장합니다.

#### **3. 실시간 장소 상태 업데이트 (관리자 GUI용)**
-   **토픽 이름**: `/rosa/location_status_update`
-   **타입**: `std_msgs/String`
-   **전송 시점**: 특정 장소의 상태(`available`, `reserved`, `busy`)가 변경될 때마다 즉시.
-   **메시지 형식**: `장소명|상태|타임스탬프`
-   **예시**: `왼쪽방|reserved|1691901500`
-   **활용 방안**: 관리자용 웹 대시보드 등에서 맵의 장소별 상태를 실시간으로 시각화할 때 사용합니다.

#### **4. 실시간 로봇 위치 업데이트 (관리자 GUI용)**
-   **토픽 이름**: `/rosa/robot_position_update`
-   **타입**: `std_msgs/String`
-   **전송 시점**: 로봇의 논리적 위치가 변경될 때마다 즉시.
-   **메시지 형식**: `로봇명|장소명`
-   **예시**: `DP_03|픽업대`
-   **활용 방안**: 관리자용 웹 대시보드에서 맵 위 로봇 아이콘의 위치를 실시간으로 이동시킬 때 사용합니다.

### **[IN] 외부 시스템 → `TaskManager`**

외부 시스템이 ROSA에게 정보를 **발행(Publish)**해야 하는 토픽입니다. ROSA는 이 토픽을 **구독(Subscribe)**하여 사용자 응답을 처리합니다.

#### **1. 수령 확인 응답**
-   **토픽 이름**: `/rosa/delivery_confirmation_response`
-   **타입**: `std_msgs/String`
-   **전송 시점**: 사용자가 GUI의 수령확인 창에서 '예(Y)' 또는 '아니오(N)' 버튼을 클릭했을 때.
-   **메시지 형식**: `업무ID|사용자ID|YES또는NO`
-   **예시**: `DP_03_1691901234|user123|YES`
-   **구현 방법**: 외부 GUI에서 버튼 클릭 이벤트가 발생하면, 이 형식에 맞는 문자열을 생성하여 해당 토픽으로 발행해야 합니다.

#### **2. 로봇 호출 요청**
-   **토픽 이름**: `/rosa/robot_call_request`
-   **타입**: `std_msgs/String`
-   **전송 시점**: 외부 사용자 GUI에서 로봇을 특정 장소로 호출하고자 할 때.
-   **메시지 형식**: `로봇명|장소명|사용자ID` (예: `DP_08|왼쪽방|user456`)
-   **활용 방안**: 이 메시지를 받으면 `TaskManager`는 해당 로봇을 지정된 장소로 이동시키는 **단순 이동 업무**를 생성합니다.

---

## **4. 외부 시스템 연동 시나리오**

**시나리오: 팀원이 개발한 웹 기반 GUI/DB 시스템을 ROSA와 연동**

1.  **(서버)** 백엔드 서버(예: Node.js)에 ROS2 클라이언트 라이브러리(`rclnodejs` 등)를 설치하고, `/rosa/delivery_confirmation_request` 토픽을 구독합니다.

2.  **(서버→GUI)** 서버가 해당 토픽에서 메시지(`...|user123|...`)를 받으면, 웹소켓 등을 이용해 `user123`의 웹 브라우저로 배달 완료 알림을 보냅니다.

3.  **(GUI)** 웹 브라우저는 알림을 받아 수령확인 UI(모달 창 등)를 띄웁니다.

4.  **(GUI→서버)** 사용자가 '예' 버튼을 클릭하면, GUI는 백엔드 서버에 `(업무ID, YES)` 정보를 전달합니다.

5.  **(서버)** 백엔드 서버는 전달받은 정보를 조합하여 `/rosa/delivery_confirmation_response` 토픽으로 `업무ID|user123|YES` 메시지를 발행(Publish)합니다.

6.  **(ROSA)** `TaskManager`가 이 응답 메시지를 받아 로봇을 충전소로 복귀시키고, 잠시 후 `/rosa/db_log` 토픽으로 최종 결과를 발행합니다.

7.  **(서버→DB)** 백엔드 서버는 `/rosa/db_log` 토픽을 항상 구독하고 있다가, 메시지를 받으면 내용을 파싱하여 데이터베이스에 저장합니다.

---

## **5. 테스트 및 디버깅 방법**

외부 시스템을 개발하면서 ROSA의 동작을 흉내 내거나, 외부 시스템의 메시지를 확인하는 방법입니다.

-   **ROSA가 보내는 요청 강제로 만들기 (GUI 테스트용)**:
    ```bash
    # 수령확인 요청을 강제로 발행하여 GUI가 받는지 테스트
    ros2 topic pub /rosa/delivery_confirmation_request std_msgs/String "data: 'TEST_ORDER|user123|DP_03|테스트방|테스트물품|123|456'"
    ```

-   **외부 시스템이 보내는 응답 확인하기**:
    ```bash
    # 외부 GUI에서 '예' 버튼을 눌렀을 때, 이 터미널에 메시지가 뜨는지 확인
    ros2 topic echo /rosa/delivery_confirmation_response
    ```

-   **ROSA가 발행하는 모든 정보 확인하기**:
    ```bash
    # DB 로그 토픽 실시간 확인
    ros2 topic echo /rosa/db_log

    # 장소 상태 토픽 실시간 확인
    ros2 topic echo /rosa/location_status_update
    ```

---

**🤝 연동 관련 질문이나 추가로 필요한 API가 있다면 언제든 편하게 요청해주세요!**
